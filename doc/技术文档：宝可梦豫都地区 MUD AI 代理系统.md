# **技术文档：宝可梦豫都地区 MUD AI 代理系统**

**版本:** 1.1 (修订 AI 集成)
**日期:** 2023年10月27日

## **目录**

1.  **引言**
    *   1.1 项目目标
    *   1.2 核心特性
    *   1.3 目标平台：Vercel
    *   1.4 独特卖点 (深度 AI 集成)
2.  **系统架构**
    *   2.1 概览图
    *   2.2 前端 (Web 界面)
    *   2.3 后端 (游戏引擎 & API)
    *   2.4 AI 代理服务 (用于特定系统)
    *   2.5 数据存储
3.  **核心游戏系统**
    *   3.1 世界与移动系统
    *   3.2 交互系统 (基础命令)
    *   3.3 玩家系统
    *   3.4 宝可梦系统 (属性、技能、返祖化)
    *   3.5 对战系统 (受 GBA 启发)
    *   3.6 捕捉系统 (直接互动)
    *   3.7 NPC 系统 (基础 & AI 驱动)
    *   3.8 物品系统
    *   3.9 世界地图系统
    *   3.10 任务/事件系统 (基础)
    *   3.11 时间系统 (可选)
4.  **AI 代理集成 (修订版)**
    *   4.1 核心目标 (非命令翻译)
    *   4.2 AI 在宝可梦培养中的集成 (技能学习)
    *   4.3 AI 在 NPC 交互中的集成 (智能对话与信息获取)
    *   4.4 AI 交互的 UI 指示
    *   4.5 通用考虑 (提示工程, 成本)
5.  **技术栈**
    *   5.1 前端
    *   5.2 后端 (API)
    *   5.3 AI 服务
    *   5.4 数据库
    *   5.5 实时通信 (可选)
6.  **数据管理**
    *   6.1 世界数据 (地点、宝可梦、NPC)
    *   6.2 玩家数据
    *   6.3 数据加载与初始化
7.  **在 Vercel 上部署**
    *   7.1 前端部署
    *   7.2 后端 API (无服务器函数)
    *   7.3 环境变量
    *   7.4 数据库连接
8.  **未来考虑**

---

## **1. 引言**

### **1.1 项目目标**
创建一个基于文本的 MUD (多用户地牢) 角色扮演游戏，背景设定在自定义的宝可梦“豫都地区”（灵感来自中国河南省）。该游戏将通过 Web 界面访问，并针对在 Vercel 上部署进行优化。

### **1.2 核心特性**
*   经典 MUD 玩法：基于文本的探索、交互和战斗。
*   基于提供的背景资料 (`豫都地区策划案.md`, 地点表格, 宝可梦数据) 的丰富世界观。
*   受 GBA 启发的宝可梦对战机制。
*   独特的直接宝可梦捕捉系统。
*   深度集成的 AI，用于增强宝可梦培养的策略性和 NPC 交互的智能性与挑战性。

### **1.3 目标平台：Vercel**
架构和技术选型将优先考虑与 Vercel 平台的兼容性和部署便利性，适当利用无服务器函数处理后端逻辑。

### **1.4 独特卖点 (深度 AI 集成)**
与传统 MUD 不同，本游戏将 AI 嵌入核心系统（如宝可梦训练和 NPC 对话），提供更动态、更具挑战性和沉浸感的游戏体验，而非仅仅作为命令输入助手。

---

## **2. 系统架构**

### **2.1 概览图**

```mermaid
graph LR
    A[用户浏览器] -- HTTPS --> B(Vercel 前端 - Next.js/React);
    B -- API 调用 (含用户输入/意图) --> C{Vercel 无服务器函数 (后端 API - Node.js)};
    C -- 游戏逻辑 --> D[游戏状态管理器];
    C -- 数据访问 --> E[数据库 (Vercel KV/Postgres/等)];
    D -- 更新 --> C;
    E -- 玩家/世界数据 --> C;

    subgraph "特定 AI 驱动流程"
        C -- (训练请求 + 上下文) --> F(AI 代理服务 - OpenAI/Anthropic API);
        F -- (训练结果建议) --> C;
        C -- (NPC 对话请求 + 上下文) --> F;
        F -- (NPC 动态回应) --> C;
    end

    subgraph "游戏数据文件"
        G[locations.json]
        H[pokedex.json]
        I[pokemon_location.json]
        J[items.json]
        K[npcs.json]
        L[moves.json]
        M[abilities.json]
    end
    G & H & I & J & K & L & M -- 由...加载 --> D;

    subgraph "前端交互"
        A -- (标准命令) --> N(命令提示符);
        N -- 发送至后端 --> C;
        A -- (特定输入, 如训练描述) --> O(特定输入区/彩色提示框);
        O -- 发送至后端 --> C;
    end

    style F fill:#f9d,stroke:#333,stroke-width:2px
    style E fill:#ccf,stroke:#333,stroke-width:1px
```

### **2.2 前端 (Web 界面)**
*   使用现代 JavaScript 框架构建 (例如, Next.js/React, SvelteKit)。
*   显示游戏输出 (房间描述、战斗日志、消息、NPC 对话)。
*   提供传统的命令输入行。
*   根据后端信号，为需要 AI 交互的特定输入区域（如训练描述）提供视觉提示（例如，改变颜色）。
*   显示玩家状态、地图 (可能是 ASCII 或简单图形)、物品栏、宝可梦队伍。
*   通过 HTTP API 调用与后端通信。

### **2.3 后端 (游戏引擎 & API)**
*   实现为无服务器函数 (例如, Vercel 上的 Node.js/TypeScript)。
*   处理来自前端的请求 (标准命令、特定交互数据)。
*   管理核心的 `GameStateManager` (游戏状态管理器)。
*   解析并执行玩家的标准命令。
*   **在特定场景下（如训练、与 AI NPC 对话），打包上下文并调用 AI 代理服务。**
*   处理 AI 返回的结果（如训练建议、动态对话）。
*   管理玩家会话和认证 (如果需要)。
*   从数据库读写数据。
*   从 JSON/MD 文件加载初始游戏世界数据。
*   **向前端发送信号，指示何时启用 AI 交互的 UI 提示。**

### **2.4 AI 代理服务 (用于特定系统)**
*   外部服务 (例如, OpenAI API, Anthropic Claude API)。
*   接收来自后端的特定任务请求和相关上下文（例如，宝可梦训练请求、NPC 对话请求）。
*   **任务：** 分析训练内容并建议技能；或根据玩家状态和 NPC 个性生成动态对话。
*   将分析/生成的结果返回给后端。

### **2.5 数据存储**
*   存储持久化的玩家数据 (位置、物品栏、宝可梦队伍、图鉴完成度、任务状态、**信用状态**、与其他 NPC 的关系标志等)。
*   适用于 Vercel 的选项：Vercel KV (Redis), Vercel Postgres, Supabase, PlanetScale, MongoDB Atlas。
*   静态世界数据 (`豫都地区地点信息表-dc0eb2fe93.json`, `pokemon_location.json`, `yudex_pokedex.json` 等) 将在启动时加载到内存中或由后端按需直接访问。

---

## **3. 核心游戏系统**

### **3.1 世界与移动系统**
*   **数据:** 基于 `豫都地区地点信息表-dc0eb2fe93.json` 和明确的房间连接地图。每个区域有 ID、描述、出口、物品、NPC、宝可梦遭遇。
*   **表示:** 内部图或字典结构。
*   **命令:** `north` (n), `south` (s), `east` (e), `west` (w), `up` (u), `down` (d), `enter <目标>`, `exit`。
*   **输出:** 新房间的名称、描述、可见内容。

### **3.2 交互系统 (基础命令)**
*   **解析器:** `动词 <名词> [介词] [间接名词]` 结构。
*   **常用动词:** `look` (l), `look at`, `get` (take), `drop`, `inventory` (inv, i), `use`, `talk to`, `ask ... about`, `give ... to`, `fight`, `catch ... [with]`, `status` (stats, info), `pokemon` (team), `pokedex`, `map`, `help`, `save`, `quit`。
*   **上下文:** 基于玩家当前位置和物品栏。

### **3.3 玩家系统**
*   **属性:** 名字、HP (当前/最大)、状态异常、徽章、金钱、位置 ID、**信用状态 (Credit Status)**。
*   **物品栏:** 物品 ID 和数量列表。
*   **宝可梦队伍:** 最多 6 只宝可梦。
*   **图鉴:** 追踪见过和捕捉到的宝可梦。
*   **数据持久化:** 玩家状态保存到数据库 (`save` 命令)。

### **3.4 宝可梦系统 (属性、技能、返祖化)**
*   **数据:** 基于 `yudex_pokedex.json`, `moves.json`, `abilities.json`, 属性相克表。
*   **核心属性:** HP、攻击、防御、特攻、特防、速度。等级、经验值、性格。
*   **战斗属性:** 类型、特性、携带物品、当前 HP、状态异常、招式组合 (最多 4 个，有 PP)。
*   **返祖化 (Atavism):** 特定宝可梦在满足条件（道具、地点、触发器）下发生的形态/属性/能力变化（临时或永久）。
*   **技能学习:** 部分技能学习过程由 AI 驱动（见 4.2）。

### **3.5 对战系统 (受 GBA 启发)**
*   **发起:** `fight <目标>` 命令或脚本遭遇。
*   **回合制:** 基于速度决定行动顺序。
*   **玩家选项:** `fight` (选招式), `pokemon` (换宝可梦), `item` (用道具), `run` (逃跑，仅限野生)。
*   **机制:** 属性克制、招式效果、暴击、状态异常、特性触发。
*   **结束:** 一方宝可梦全部倒下，结算经验值、金钱。
*   **输出:** 详细战斗日志。

### **3.6 捕捉系统 (直接互动)**
*   **发起:** `catch <宝可梦名> [with <精灵球>]`，战斗外使用。
*   **概念:** 非战斗削弱，通过文本描述的直接互动尝试（潜行、喂食、快速挑战）。
*   **机制:** 成功率受基础捕获率、宝可梦状态、精灵球种类影响。可能需要玩家互动（文本选择或简单检定）。失败可能导致逃跑或战斗。
*   **物品影响:** 捕捉前使用某些物品可能提高成功率。
*   **输出:** 描述尝试过程和结果。

### **3.7 NPC 系统 (基础 & AI 驱动)**
*   **数据:** 在 `npcs.json` 中定义，包含名称、描述、**个性档案**、**是否 AI 驱动标记**、对话树（基础 NPC）、训练师状态、初始关系等。
*   **基础 NPC:** 使用预设的对话树或简单响应。
*   **AI 驱动 NPC:** 交互 (`talk`, `ask`) 调用 AI 服务生成动态响应（见 4.3）。
*   **交互:** `look at`, `talk to`, `ask ... about`, `give ... to`, `fight` (训练师)。

### **3.8 物品系统**
*   **数据:** 定义于 `items.json`，包含名称、描述、类型（消耗品、关键物品、精灵球、**训练触发道具**、返祖化信物等）、效果。
*   **交互:** `get`, `drop`, `use`, `give`, `inventory`。

### **3.9 世界地图系统**
*   **命令:** `map`。
*   **输出:** ASCII 地图、文本列表或由前端处理静态地图。
*   **数据:** 需要区域连接数据。

### **3.10 任务/事件系统 (基础)**
*   **机制:** 基于玩家数据中的标志 (flag) 系统。
*   **触发:** 通过交互、进入地点、战斗胜利等设置或检查标志。
*   **效果:** 解锁对话、区域、获得奖励。**任务结果可能影响玩家信用或 NPC 关系。**

### **3.11 时间系统 (可选)**
*   追踪昼夜，影响宝可梦出现、事件。

---

## **4. AI 代理集成 (修订版)**

### **4.1 核心目标 (非命令翻译)**
本系统的 AI 不用于翻译玩家的自然语言命令。相反，AI 将深度集成到特定的游戏子系统中，为这些系统增加动态性、智能和挑战性。AI 的存在旨在模拟更真实的角色行为和更具探索性的培养过程。

### **4.2 AI 在宝可梦培养中的集成 (技能学习)**
*   **触发机制:** 当玩家使用特定道具对宝可梦进行训练，并提供训练重点的描述时 (`train <宝可梦> using <道具> focus "<训练描述文本>"` )。
*   **所需上下文 (发送给 AI):** 目标宝可梦信息、训练道具、玩家描述文本、宝可梦潜在可学招式列表。
*   **AI 任务:** 分析训练内容 -> 评估宝可梦 -> 在潜在招式中匹配最符合训练内容的招式 -> 输出建议。
*   **后端处理:** 接收 AI 建议，处理招式学习逻辑（如替换旧招式）。
*   **游戏性影响:** 技能学习更具策略性和探索性，结果基于 AI 对训练描述的理解。

### **4.3 AI 在 NPC 交互中的集成 (智能对话与信息获取)**
*   **触发机制:** 与标记为“AI 驱动”的关键 NPC 进行交互 (`talk`, `ask`)。
*   **所需上下文 (发送给 AI):** NPC 身份与个性档案、玩家询问的话题、玩家状态（信用、等级、关系、信物等）、（可选）对话历史。
*   **AI 任务:** 评估情境 -> **信息门控**（根据条件判断是否提供信息）-> 生成符合 NPC 个性和当前情境的动态回应（可能友好、回避、敷衍、误导或敌对）。
*   **后端处理:** 调用 AI 服务获取对话文本，并显示给玩家。
*   **游戏性影响:** 提升 NPC 交互的真实感和挑战性，信息获取需要玩家努力提升自身状态或改善关系。

### **4.4 AI 交互的 UI 指示**
*   **机制:** 后端在需要 AI 交互时（如请求训练描述、与 AI NPC 对话）发送信号给前端。
*   **前端响应:** 根据信号，改变相应输入框或界面的视觉样式（如颜色），提示玩家当前交互涉及 AI。

### **4.5 通用考虑 (提示工程, 成本)**
*   **提示工程:** 设计有效的 Prompt 对指导 AI 完成训练分析和对话生成任务至关重要。
*   **成本与性能:** 合理规划 AI 调用时机，避免不必要的开销和延迟。

---

## **5. 技术栈**

### **5.1 前端**
*   **推荐:** Next.js (React) 或 SvelteKit。
*   **UI:** Basic HTML/CSS, Tailwind CSS, Chakra UI 或类似库。

### **5.2 后端 (API)**
*   **推荐:** Node.js with TypeScript/JavaScript, 部署为 Vercel Serverless Functions。

### **5.3 AI 服务**
*   **推荐:** Grok AI。

### **5.4 数据库**
*   **推荐:** Vercel KV, Vercel Postgres, Supabase, PlanetScale, MongoDB Atlas。

### **5.5 实时通信 (可选)**
*   **选项:** WebSockets (需额外服务如 Ably 或特定配置) 或 Server-Sent Events (SSE)。
*   **初期:** 可依赖标准 HTTP 请求/响应。

---

## **6. 数据管理**

### **6.1 世界数据**
*   解析 JSON/MD 文件 (地点、宝可梦、图鉴、物品、**招式、特性、NPC 数据[含个性档案和 AI 标记]**、房间连接等)。
*   加载到内存或按需访问。

### **6.2 玩家数据**
*   定义数据库 Schema，包含基础信息、队伍（含每只宝可梦的详细状态）、物品栏、图鉴状态、任务标志、**信用状态、关系标志**等。

### **6.3 数据加载与初始化**
*   后端启动时加载静态世界数据。
*   玩家连接时从数据库加载其动态数据。

---

## **7. 在 Vercel 上部署**

### **7.1 前端部署**
*   将 Git 仓库连接到 Vercel 实现自动构建和部署。

### **7.2 后端 API (无服务器函数)**
*   将 API 代码放在 Vercel 识别的目录（如 `/api` for Next.js）或通过 `vercel.json` 配置。

### **7.3 环境变量**
*   使用 Vercel 的环境变量管理功能存储 API 密钥、数据库连接字符串等敏感信息。

### **7.4 数据库连接**
*   后端函数使用环境变量配置数据库连接，注意连接管理（如连接池）以适应无服务器环境。

---

## **8. 未来考虑**

*   多人游戏支持（状态同步、实时通信）。
*   更复杂的 AI 行为（长期记忆、NPC 主动行为、更细致的情感模拟）。
*   图形化界面元素（地图、精灵图等）。
*   更复杂的任务系统，与 AI NPC 的交互深度结合。
*   玩家对战 (PvP)。
*   宝可梦交易系统。
*   制作系统。
*   更深入的返祖化机制和相关传说故事线。
